<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Pago - Checkout</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <style>
    .paso-activo {
      background-color: #28a745;
      color: white;
    }
    .step-circle {
      width: 40px;
      height: 40px;
      line-height: 40px;
      border-radius: 50%;
      text-align: center;
      font-weight: bold;
    }
    .opcion-pago {
      cursor: pointer;
      border: 2px solid #ccc;
      padding: 10px;
      border-radius: 8px;
      margin-bottom: 10px;
    }
    .opcion-pago:hover {
      border-color: #28a745;
    }
    .opcion-activa {
      border-color: #28a745 !important;
      background-color: #e9f7ef;
    }
    .resumen-producto {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 10px;
    }
    .resumen-producto img {
      width: 60px;
      height: 60px;
      object-fit: cover;
      border-radius: 5px;
    }
  </style>
</head>

<body class="bg-light">
  <div class="container py-4">

    <div class="mb-4 d-flex gap-3 align-items-center">
      <div class="step-circle paso-activo">1</div>
      <div>Identificación</div>
      <div class="step-circle paso-activo">2</div>
      <div>Envío</div>
      <div class="step-circle paso-activo">3</div>
      <div>Pago</div>
    </div>

    <div class="row g-4">
      <div class="col-lg-8">
        <div class="card p-4">
          <h5 class="mb-3">Selecciona tu método de pago</h5>

          <form action="../PHP/procesar_pago.php" method="POST" id="formPago" onsubmit="return validarFormulario()">
            <input type="hidden" name="metodo" id="metodoPago" required>

            <!-- Métodos de pago -->
            <div class="opcion-pago" onclick="seleccionarPago('yape')">
              <input type="radio" name="pago" value="yape"> Yape
              <div class="mt-2" id="infoYape" style="display:none">
                <p>¡Paga con Yape en pocos minutos!</p>
                <ol>
                  <li>Completa tus datos.</li>
                  <li>Ingresa tu celular asociado a Yape y el código.</li>
                  <li>¡Listo!</li>
                </ol>
              </div>
            </div>

            <div class="opcion-pago" onclick="seleccionarPago('efectivo')">
              <input type="radio" name="pago" value="efectivo"> Pago Efectivo
              <div class="mt-2" id="infoEfectivo" style="display:none">
                <p>Se generará un código para pagar en agentes autorizados.</p>
              </div>
            </div>

            <div class="opcion-pago" onclick="seleccionarPago('tarjeta')">
              <input type="radio" name="pago" value="tarjeta"> Tarjeta de Crédito/Débito
              <div class="mt-2" id="infoTarjeta" style="display:none">
                <div class="mb-3">
                  <label>Número de tarjeta</label>
                  <input type="text" name="tarjeta_num" class="form-control">
                </div>
                <div class="mb-3">
                  <label>Nombre como figura en la tarjeta</label>
                  <input type="text" name="tarjeta_nombre" class="form-control">
                </div>
                <div class="row">
                  <div class="col">
                    <label>Vencimiento</label>
                    <input type="text" name="vencimiento" class="form-control" placeholder="MM/AA">
                  </div>
                  <div class="col">
                    <label>CVV</label>
                    <input type="text" name="cvv" class="form-control">
                  </div>
                </div>
              </div>
            </div>

            <!-- Datos ocultos -->
            <input type="hidden" name="nombre" id="inputNombre">
            <input type="hidden" name="email" id="inputEmail">
            <input type="hidden" name="celular" id="inputCelular">
            <input type="hidden" name="direccion" id="inputDireccion">
            <input type="hidden" name="fecha" id="inputFecha">
            <input type="hidden" name="total" id="inputTotal">

            <!-- Botón de envío -->
            <button type="submit" class="btn btn-success w-100 mt-3">
              <i class="fas fa-credit-card"></i> Finalizar compra
            </button>
          </form>
        </div>
      </div>

      <div class="col-lg-4">
        <div class="card p-4">
          <h5 class="mb-3">Resumen de la Compra</h5>
          <div id="resumenProductos"></div>
          <hr>
          <p><strong>Subtotal:</strong> S/. <span id="subtotal"></span></p>
          <p><strong>Gastos de envío:</strong> Gratis</p>
          <hr>
          <h5>Total: S/. <span id="total"></span></h5>
        </div>
      </div>
    </div>
  </div>

  <script>
    function cargarResumen() {
      const carrito = JSON.parse(localStorage.getItem("carrito")) || [];
      const resumen = document.getElementById("resumenProductos");
      resumen.innerHTML = "";
      let subtotal = 0;

      carrito.forEach(p => {
        subtotal += p.precio * p.cantidad;
        resumen.innerHTML += `
          <div class="resumen-producto">
            <img src="${p.imagen}" alt="${p.nombre}">
            <div class="flex-grow-1">
              <div><strong>${p.nombre}</strong></div>
              <div>Cantidad: ${p.cantidad}</div>
              <div>Precio: S/.${(p.precio * p.cantidad).toFixed(2)}</div>
            </div>
          </div>`;
      });

      document.getElementById("subtotal").textContent = subtotal.toFixed(2);
      document.getElementById("total").textContent = subtotal.toFixed(2);
      document.getElementById("inputTotal").value = subtotal.toFixed(2);
    }

    function seleccionarPago(metodo) {
      document.getElementById("metodoPago").value = metodo;
      document.querySelectorAll(".opcion-pago").forEach(div => div.classList.remove("opcion-activa"));
      document.querySelector(`[onclick="seleccionarPago('${metodo}')"]`).classList.add("opcion-activa");

      ["infoYape", "infoEfectivo", "infoTarjeta"].forEach(id =>
        document.getElementById(id).style.display = "none"
      );
      document.getElementById("info" + metodo.charAt(0).toUpperCase() + metodo.slice(1)).style.display = "block";
    }

    function validarFormulario() {
      const metodo = document.getElementById("metodoPago").value;
      if (!metodo) {
        alert("Por favor selecciona un método de pago.");
        return false;
      }
      return true;
    }

    document.addEventListener("DOMContentLoaded", () => {
      cargarResumen();

      const identificacion = JSON.parse(localStorage.getItem("datosIdentificacion"));
      const envio = JSON.parse(localStorage.getItem("datosEnvio"));

      if (identificacion && envio) {
        document.getElementById("inputNombre").value = identificacion.nombre;
        document.getElementById("inputEmail").value = identificacion.email;
        document.getElementById("inputCelular").value = identificacion.celular;
        document.getElementById("inputDireccion").value = envio.direccion;
        document.getElementById("inputFecha").value = envio.fecha;
      } else {
        alert("Faltan datos. Por favor, vuelve a identificación.");
        window.location.href = "identificacion.html";
      }
    });
  </script>
</body>
</html>

